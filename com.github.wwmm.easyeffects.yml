# see https://github.com/wwmm/easyeffects/blob/master/PKGBUILD for dependencies
# If you get errors like 137, you might need pass --jobs=1 to flatpak-builder to limit cpu threads.
# discussion at here https://github.com/flathub/com.github.wwmm.pulseeffects/pull/53

id: com.github.wwmm.easyeffects
runtime: org.gnome.Platform
runtime-version: '41'
sdk: org.gnome.Sdk
command: easyeffects-wrapper
rename-icon: easyeffects
finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri
  - --filesystem=xdg-run/pipewire-0:ro
    # LV2 Plugin PATH
  - --env=LV2_PATH=/app/lib/lv2:/app/extensions/Plugins/lv2
cleanup:
  - '*.a'
  - '*.h'
  - '*.la'
  - /bin/analyseplugin
  - /bin/applyplugin
  - /bin/listplugins
  - /include
  - /lib/pkgconfig
  - /lib/python*
  - /share/info

add-extensions:
  org.freedesktop.LinuxAudio.Plugins:
    directory: extensions/Plugins
    version: '20.08'
    add-ld-path: lib
    merge-dirs: lv2
    subdirectories: true
    no-autodownload: true

  org.freedesktop.LinuxAudio.Plugins.LSP:
    directory: extensions/Plugins/LSP
    version: '20.08'
    add-ld-path: lib
    merge-dirs: lv2
    autodelete: false
    subdirectories: true

  org.freedesktop.LinuxAudio.Plugins.ZamPlugins:
    directory: extensions/Plugins/ZamPlugins
    version: '20.08'
    add-ld-path: lib
    merge-dirs: lv2
    autodelete: false
    subdirectories: true

modules:
  - name: easyeffects
    buildsystem: meson
    sources:
      - type: git
        url: https://github.com/wwmm/easyeffects.git
        # tag: v6.1.4
        commit: 396a92d6e2f6ef002ebfb2b9abe6f025375ccd62
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)
      - type: file
        path: easyeffects-wrapper.sh
      - type: patch
        path: patch/easyeffects/001-fix-about-page-icon.patch
      - type: patch
        path: patch/easyeffects/002-fix-desktop-file.patch
      - type: patch
        path: patch/easyeffects/003-libportal-autostart.patch
      - type: shell
        commands:
          - install -Dvm 755 easyeffects-wrapper.sh $FLATPAK_DEST/bin/easyeffects-wrapper
    post-install:
      - install -Dm644 -t $FLATPAK_DEST/share/licenses/$FLATPAK_ID ../LICENSE.md
      - mkdir -pm755 $FLATPAK_DEST/extensions/Plugins
    modules:

      - name: glibmm
        buildsystem: meson
        config-opts:
          - -Dbuild-documentation=false
        sources:
          - type: git
            url: https://gitlab.gnome.org/GNOME/glibmm.git
            tag: 2.70.0
            commit: 042e90eebca380686bbcc24d6803305b9d2c7823
            x-checker-data:
              type: git
              tag-pattern: ^([\d.]+)
            cleanup:
              - /lib/glibmm*
              - /lib/giomm*
        modules:

          - name: mm-common
            buildsystem: meson
            sources:
              - type: archive
                url: https://download.gnome.org/sources/mm-common/1.0/mm-common-1.0.3.tar.xz
                sha256: e81596625899aacf1d0bf27ccc2fcc7f373405ec48735ca1c7273c0fbcdc1ef5
                # gnome download source missing json file that f-e-d-c needs
                # git source results in "Error: libstdc++.tag does not exist."
            cleanup:
              - '*'

          - name: libsigc++
            buildsystem: meson
            config-opts:
              - -Dbuild-examples=false
            sources:
              - type: archive
                url: https://download.gnome.org/sources/libsigc++/3.0/libsigc++-3.0.7.tar.xz   # git release doesn't provide dot dependency
                sha256: bfbe91c0d094ea6bbc6cbd3909b7d98c6561eea8b6d9c0c25add906a6e83d733
                x-checker-data:
                  type: gnome
                  name: libsigc++
                  stable-only: true

            cleanup:
              - /lib/sigc++*
      - name: gtkmm
        buildsystem: meson
        config-opts:
          - -Dbuild-documentation=false
        sources:
          - type: git
            url: https://gitlab.gnome.org/GNOME/gtkmm.git
            tag: 4.4.0
            commit: 44bb79e8ee6e86bdc2e6275b8b9c3bded7ec0b3a
            x-checker-data:
              type: git
              tag-pattern: ^([\d.]+)

            cleanup:
              - /lib/gdkmm*
              - /lib/gtkmm*
        modules:

          - name: atkmm
            buildsystem: meson
            config-opts:
              - -Dbuild-documentation=false
            sources:
              - type: archive
                url: https://download.gnome.org/sources/atkmm/2.36/atkmm-2.36.1.tar.xz
                sha256: e11324bfed1b6e330a02db25cecc145dca03fb0dff47f0710c85e317687da458
                x-checker-data:
                  type: gnome
                  name: atkmm
                  stable-only: true
            cleanup:
              - /lib/atkmm*

          - name: cairomm
            build-options:
              - git config fsck.skiplist "$PWD/.git/skiplist" # Necessary to skip git fsck check for a commit in the cairomm repo
              - echo "016c362e95d96e129374b07258b246bc2412c526" >> .git/skiplist # See https://gitlab.freedesktop.org/cairo/cairomm/-/issues/28
            config-opts:
              - --disable-documentation
            sources:
              # cairomm >= 1.14.0 requires sigc++ 3.0 and other modules require cairomm < 1.13.0
              - type: git
                url: https://gitlab.freedesktop.org/cairo/cairomm.git
                tag: 1.16.1
                commit: 61286896d11ed961add217ff4a209d10d9efb700
                x-checker-data:
                  type: git
                  tag-pattern: ^([\d.]+)
            post-install:
              - install -Dm644 -t /app/share/licenses/cairomm COPYING
            cleanup:
              - /lib/cairomm*

          - name: pangomm
            buildsystem: meson
            config-opts:
              - -Dbuild-documentation=false
            sources:
              - type: git
                url: https://gitlab.gnome.org/GNOME/pangomm.git
                tag: 2.49.1
                commit: 73a834196de6e3b016a16fab299865c0caffad26
                x-checker-data:
                  type: git
                  tag-pattern: ^([\d.]+)
            cleanup:
              - /lib/pangomm*

      - name: libebur128
        buildsystem: cmake-ninja
        config-opts:
          - -DCMAKE_BUILD_TYPE=Release
          - -DBUILD_STATIC_LIBS=OFF
          - -DCMAKE_INSTALL_LIBDIR=lib
        sources:
          - type: git
            url: https://github.com/jiixyj/libebur128.git
            tag: v1.2.6
            commit: 67b33abe1558160ed76ada1322329b0e9e058b02
            x-checker-data:
              type: git
              tag-pattern: ^v([\d.]+)
        post-install:
          - install -Dm644 -t $FLATPAK_DEST/share/licenses/libebur128 COPYING

      - name: zita-convolver
        no-autogen: true
        subdir: source
        make-install-args:
          - PREFIX=${FLATPAK_DEST}
          - LIBDIR=${FLATPAK_DEST}/lib
        sources:
          - type: archive
            url: https://kokkinizita.linuxaudio.org/linuxaudio/downloads/zita-convolver-4.0.3.tar.bz2
            sha512: 62d7841757f10c094e43ed755e187f947c5743f302ed2a1ee6064a850c18921466f4505d8a2a7b3ad23619db7f1ad7307e1dfb2e8a1e7685e60ece2ffff4f6ca
          - type: patch
            path: patch/zita-convolver/0001-Fix-makefile.patch
            # still necessary as of 2021-08-04
        modules:
          - shared-modules/linux-audio/fftw3f.json
          - shared-modules/linux-audio/lv2.json
          - shared-modules/linux-audio/lilv.json   # Required by libgstlv2.so

          - name: bs2b
            rm-configure: true
            sources:
              - type: archive
                url: https://downloads.sourceforge.net/sourceforge/bs2b/libbs2b-3.1.0.tar.gz   # was last updated in 2009 so x-checker-data probably not too helpful
                sha256: 6aaafd81aae3898ee40148dd1349aab348db9bfae9767d0e66e0b07ddd4b2528
              - type: script
                dest-filename: autogen.sh
                commands:
                  - cp -p /usr/share/automake-*/config.{sub,guess} build-aux
                  - autoreconf -vfi
              - type: patch
                path: patch/bs2b/001-fix-automake-dist-lzma.patch
                # still necessary as of 2021-08-04
            post-install:
              - install -Dm644 -t $FLATPAK_DEST/share/licenses/bs2b COPYING
            cleanup:
              - /bin

          - name: speexdsp
            buildsystem: autotools
            sources:
              - type: git
                url: https://gitlab.xiph.org/xiph/speexdsp
                tag: SpeexDSP-1.2.0
                commit: 64cbfa9bca7479a758351aa02bb4abdd76baa9e7
                x-checker-data:
                  type: git
                  tag-pattern: ^SpeexDSP-([\d.]+)
                # Note to future Flatpakers: webrtc-audio-processing has a module in the pulseeffects manifest that could replace speexdsp.
                # Why it was removed: https://github.com/flathub/com.github.wwmm.pulseeffects/issues/44#issuecomment-885999963
                # Original module: https://github.com/flathub/com.github.wwmm.pulseeffects/blob/81e34d9bf6ee08610ac8bf79454412c3eaaa83ce/com.github.wwmm.pulseeffects.yml#L225
                # You might also need the patch from that repo: https://github.com/flathub/com.github.wwmm.pulseeffects/blob/81e34d9bf6ee08610ac8bf79454412c3eaaa83ce/patch/webrtc-audio-processing/0001-build-Use-cmake-to-look-up-abseil-dependency.patch
          # LV2 Plugins
          # manifest module from: https://github.com/flathub/io.mpv.Mpv/blob/73681476e1abde88770804c497f03c4bfea027f6/io.mpv.Mpv.yml#L223
          - name: rubberband
            buildsystem: meson
            cleanup:
              - /include
              - /lib/*.a
              - /lib/pkgconfig
            sources:
              - type: archive
                url: https://breakfastquay.com/files/releases/rubberband-1.9.2.tar.bz2
                sha256: b3cff5968517141fcf9e1ef6b5a1fdb06a5511f148000609216cf182ff4ab612
                x-checker-data:
                  type: html
                  url: https://www.breakfastquay.com/rubberband/
                  version-pattern: Rubber Band Library v(\d\.\d+\.?\d*) source
                  url-template: https://breakfastquay.com/files/releases/rubberband-$version.tar.bz2

          - name: calf
            sources:
              - type: git
                url: https://github.com/calf-studio-gear/calf.git
                tag: 0.90.3
                commit: 41a2b7fb029cf0099fc05b7a9c569208034018de
                x-checker-data:
                  type: git
                  tag-pattern: ^([\d.]+)
            post-install:
              - install -Dm644 -t $FLATPAK_DEST/share/licenses/calf COPYING
            cleanup:
              - /bin
              - /share/applications
              - /share/bash-completion
              - /share/calf
              - /share/doc
              - /share/icons
              - /share/man
            modules:
              - shared-modules/linux-audio/fluidsynth2.json

      - name: rnnoise
        sources:
          - type: git
            url: https://github.com/xiph/rnnoise.git
            commit: 1cbdbcf1283499bbb2230a6b0f126eb9b236defd
          #  x-checker-data: might not work properly since no tags upstream: https://github.com/xiph/rnnoise/issues/137

        cleanup:
          - /share/doc/rnnoise

      # Easyeffects 6.0.0 depends on pipewire >=0.3.31, gnome 40 runtime has 0.3.25
      # Ensure to update easyeffects-wrapper.sh when updating pipewire version.
      - name: pipewire
        buildsystem: meson
        config-opts:
          - -Dgstreamer=disabled
          - -Dman=disabled
          - -Dsystemd=disabled
          - -Dudev=disabled
          - -Dudevrulesdir=disabled
        sources:
          - type: git
            url: https://gitlab.freedesktop.org/pipewire/pipewire.git
            tag: 0.3.31
            commit: c43dabcc96e2e072cdf08e5f094bb677d9017c6b

      - name: nlohmann-json
        buildsystem: cmake-ninja
        config-opts:
          - -DCMAKE_BUILD_TYPE=Release
        sources:
          - type: archive
            url: https://github.com/nlohmann/json/archive/v3.10.3.tar.gz
            sha256: e0d7c1b120cac47fa7f14a41d10a5d390f67d423d8e97b9d6834887285d6873c
            x-checker-data:
              type: anitya
              project-id: 141453
              url-template: https://github.com/nlohmann/json/archive/v$version.tar.gz

      - name: libportal
        buildsystem: meson
        sources:
          - type: git
            url: https://github.com/flatpak/libportal.git
            tag: '0.4'
            commit: f68764e288ede516d902b131cc4fadded3804059

      - name: zenity
        buildsystem: meson
        sources:
          - type: git
            url: https://gitlab.gnome.org/GNOME/zenity
            tag: 3.41.0
            commit: d8857f446b602d5fb4a41fef3d8a63507a12b72c
